# WPS 机器人管理系统 - 快速开始指南

## 第一步：安装依赖

在项目目录下创建虚拟环境并安装依赖：

```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# Windows
venv\Scripts\activate
# Linux/Mac
# source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

## 第二步：配置环境变量

项目已经生成了 `.env` 文件，默认配置如下：

- **管理员用户名**: admin
- **管理员密码**: admin123456
- **调试模式**: 已启用

**生产环境请务必修改密钥和密码！**

## 第三步：初始化数据库

```bash
# 创建数据库迁移
python manage.py makemigrations

# 应用迁移
python manage.py migrate

# 创建默认管理员账号
python manage.py create_default_admin
```

## 第四步：启动服务器

```bash
python manage.py runserver
```

访问 http://127.0.0.1:8000/ 即可看到登录页面。

## 第五步：登录并开始使用

使用默认管理员账号登录：
- **用户名**: admin
- **密码**: admin123456

登录后您可以：
1. 创建机器人
2. 配置机器人的 Webhook URL
3. 设置 Hook 脚本处理消息
4. 发送测试消息
5. 查看消息记录
6. 管理用户账号（管理员权限）

## 使用机器人

### 1. 创建机器人

在"我的机器人"页面点击"创建新机器人"，填写：
- **机器人名称**: 用于生成回调地址
- **Webhook URL**: WPS机器人的webhook地址（用于发送消息）
- **Hook脚本**: 处理接收消息的脚本名称（如：example_hook）

### 2. 获取 Webhook 回调地址

创建机器人后，在机器人详情页可以看到回调地址，格式为：
```
http://your-domain.com/用户名/机器人名称
```

将此地址配置到 WPS 机器人管理后台。

### 3. 编写 Hook 脚本

在 `robots/hooks/` 目录下创建Python脚本，例如 `my_hook.py`：

```python
def process_message(robot, message_data):
    """处理webhook消息"""
    print(f"收到消息: {message_data}")
    
    # 处理逻辑...
    
    # 可选：返回响应
    return {
        "msg_type": "text",
        "content": {
            "text": "消息已处理"
        }
    }
```

然后在机器人配置中设置 Hook 脚本为 `my_hook`（不含.py）。

### 4. 发送消息

在机器人详情页点击"发送消息"，选择消息类型（文本或Markdown），输入内容即可发送。

## 管理员功能

管理员账号可以：
- 查看所有用户
- 创建新用户
- 编辑用户信息
- 修改用户密码
- 设置用户为管理员
- 删除用户

## 常见问题

### Q: 如何修改管理员密码？
A: 编辑 `.env` 文件中的 `DEFAULT_ADMIN_PASSWORD`，然后删除数据库重新初始化。或在Web控制台的用户管理中修改。

### Q: Webhook 回调不工作？
A: 确保：
1. 机器人已启用
2. WPS后台正确配置了回调地址
3. 服务器可以从外网访问（开发环境可使用内网穿透工具如 ngrok）

### Q: Hook 脚本没有执行？
A: 检查：
1. 脚本文件是否在 `robots/hooks/` 目录下
2. 文件名是否正确（不含.py后缀）
3. 函数名是否为 `process_message`
4. 查看服务器日志是否有错误信息

### Q: 如何部署到生产环境？
A: 参考Django官方部署文档，主要步骤：
1. 设置 `DEBUG=False`
2. 修改 `SECRET_KEY`
3. 配置 `ALLOWED_HOSTS`
4. 使用生产级数据库（PostgreSQL/MySQL）
5. 配置 Nginx/Apache
6. 使用 Gunicorn/uWSGI

## 技术支持

如有问题，请查看：
- Django文档: https://docs.djangoproject.com/
- WPS开放平台文档: https://365.kdocs.cn/3rd/open/documents/
