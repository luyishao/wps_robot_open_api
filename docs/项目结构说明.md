# WPS 机器人管理系统 - 项目结构说明

## 项目目录结构

```
wps_open_api/
│
├── manage.py                          # Django管理脚本
├── requirements.txt                   # Python依赖包列表
├── .env                              # 环境变量配置文件（已生成）
├── .env.example                      # 环境变量示例文件
├── .gitignore                        # Git忽略文件配置
├── README.md                         # 项目说明文档
├── 快速开始.md                       # 快速开始指南
├── WPS协作后台机器人Django项目需求.md  # 需求文档
│
├── wps_robot/                        # Django项目配置目录
│   ├── __init__.py
│   ├── settings.py                   # 项目设置
│   ├── urls.py                       # 主URL配置
│   ├── wsgi.py                       # WSGI配置
│   └── asgi.py                       # ASGI配置
│
├── robots/                           # 机器人应用目录
│   ├── __init__.py
│   ├── models.py                     # 数据模型（Robot, Message, UserProfile）
│   ├── views.py                      # 视图函数（业务逻辑）
│   ├── urls.py                       # URL路由配置
│   ├── forms.py                      # 表单定义
│   ├── admin.py                      # Django管理后台配置
│   ├── apps.py                       # 应用配置
│   ├── tests.py                      # 单元测试
│   │
│   ├── templates/                    # 模板文件目录
│   │   └── robots/
│   │       ├── base.html            # 基础模板
│   │       ├── login.html           # 登录页面
│   │       ├── dashboard.html       # 控制台首页
│   │       ├── robot_list.html      # 机器人列表
│   │       ├── robot_form.html      # 机器人表单（创建/编辑）
│   │       ├── robot_detail.html    # 机器人详情
│   │       ├── robot_confirm_delete.html  # 删除确认
│   │       ├── send_message.html    # 发送消息
│   │       ├── message_list.html    # 消息列表
│   │       ├── user_management.html # 用户管理
│   │       ├── user_form.html       # 用户表单
│   │       └── user_confirm_delete.html  # 用户删除确认
│   │
│   ├── hooks/                        # Hook脚本目录
│   │   ├── __init__.py
│   │   ├── example_hook.py          # 示例Hook脚本
│   │   └── echo_hook.py             # 回显Hook示例
│   │
│   ├── management/                   # 管理命令目录
│   │   ├── __init__.py
│   │   └── commands/
│   │       ├── __init__.py
│   │       └── create_default_admin.py  # 创建默认管理员命令
│   │
│   └── migrations/                   # 数据库迁移文件目录
│       └── __init__.py
│
└── static/                           # 静态文件目录（CSS、JS、图片等）
    └── .gitkeep

```

## 主要文件说明

### 配置文件

- **`.env`**: 环境变量配置，包含敏感信息（已生成，包含默认配置）
- **`requirements.txt`**: Python依赖包列表
- **`wps_robot/settings.py`**: Django项目配置

### 数据模型 (models.py)

1. **Robot**: 机器人模型
   - 存储机器人信息（名称、所有者、webhook URL等）
   - 每个用户可以拥有多个机器人

2. **Message**: 消息记录模型
   - 存储发送和接收的消息
   - 记录消息状态和错误信息

3. **UserProfile**: 用户扩展信息
   - 存储用户是否为管理员等额外信息

### 视图 (views.py)

包含所有业务逻辑：

**认证相关**:
- `user_login`: 用户登录
- `user_logout`: 用户登出

**机器人管理**:
- `robot_list`: 机器人列表
- `robot_create`: 创建机器人
- `robot_edit`: 编辑机器人
- `robot_delete`: 删除机器人
- `robot_detail`: 机器人详情

**消息管理**:
- `send_message`: 发送消息到WPS
- `message_list`: 消息记录列表
- `webhook_callback`: 接收WPS webhook回调

**用户管理（管理员）**:
- `user_management`: 用户管理
- `user_create`: 创建用户
- `user_edit`: 编辑用户
- `user_delete`: 删除用户

### URL路由 (urls.py)

定义所有URL路径映射，webhook回调地址格式：
```
/<用户名>/<机器人名称>
```

### Hook脚本 (hooks/)

用于处理接收到的webhook消息：

- **example_hook.py**: 完整的示例脚本，展示各种处理场景
- **echo_hook.py**: 简单的回显示例

自定义Hook脚本需要实现 `process_message(robot, message_data)` 函数。

### 管理命令

- **create_default_admin**: 创建默认管理员账号

使用方法：
```bash
python manage.py create_default_admin
```

## 核心功能实现

### 1. Webhook接收

- URL: `/<用户名>/<机器人名称>`
- 方法: POST
- 功能: 接收WPS发送的webhook消息并处理

### 2. 消息发送

- 通过Web界面向配置的webhook URL发送消息
- 支持文本和Markdown格式
- 记录发送结果

### 3. Hook脚本处理

- 动态加载并执行Python脚本
- 支持自定义消息处理逻辑
- 可以返回响应数据

### 4. 用户权限管理

- 普通用户：管理自己的机器人
- 管理员：可以管理所有用户

### 5. Web控制台

- 美观的Bootstrap界面
- 响应式设计
- 完整的CRUD操作

## 数据库设计

使用SQLite（开发环境）或PostgreSQL/MySQL（生产环境）

**主要数据表**:
1. `auth_user`: Django内置用户表
2. `robots_userprofile`: 用户扩展信息
3. `robots_robot`: 机器人信息
4. `robots_message`: 消息记录

## 安全性

- CSRF保护（除webhook回调外）
- 登录认证要求
- 管理员权限检查
- 密码加密存储
- SQL注入防护（Django ORM）

## 扩展建议

1. **添加更多消息类型**: 支持图片、文件等
2. **消息队列**: 使用Celery处理异步任务
3. **日志系统**: 完善的日志记录
4. **API接口**: 提供RESTful API
5. **监控告警**: 机器人状态监控
6. **批量操作**: 批量发送消息
7. **消息模板**: 预定义消息模板
8. **统计分析**: 消息统计和分析

## 技术栈

- **后端框架**: Django 4.2.9
- **REST框架**: Django REST Framework 3.14.0
- **HTTP客户端**: Requests 2.31.0
- **环境变量**: python-dotenv 1.0.0
- **前端**: Bootstrap 5.1.3
- **图标**: Bootstrap Icons 1.8.0
- **数据库**: SQLite（开发）/ PostgreSQL/MySQL（生产）

## 下一步

1. 阅读 `快速开始.md` 了解如何启动项目
2. 阅读 WPS 开放平台文档了解 webhook 机制
3. 根据业务需求编写自定义 Hook 脚本
4. 部署到生产环境
