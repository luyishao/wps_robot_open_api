# é¡¹ç›®æ›´æ–°è¯´æ˜ v2.0

## ğŸ“… æ›´æ–°æ—¥æœŸ
2026-01-30

## âœ¨ æ–°å¢åŠŸèƒ½

### 1. Hookè„šæœ¬ä¸Šä¼ åŠŸèƒ½ ğŸ¯

**åŠŸèƒ½è¯´æ˜**ï¼š
- æ”¯æŒé€šè¿‡Webç•Œé¢ç›´æ¥ä¸Šä¼ Pythonè„šæœ¬æ–‡ä»¶
- ä¸Šä¼ çš„è„šæœ¬ä¼˜å…ˆçº§é«˜äºé¢„è®¾è„šæœ¬
- æ–‡ä»¶å¤§å°é™åˆ¶ï¼š1MB
- ä»…æ”¯æŒ.pyæ ¼å¼æ–‡ä»¶

**æ•°æ®åº“å˜æ›´**ï¼š
- `Robot`æ¨¡å‹æ–°å¢å­—æ®µï¼š`hook_script_file`ï¼ˆFileFieldï¼‰

**ä½¿ç”¨æ–¹æ³•**ï¼š
1. ç¼–è¾‘æœºå™¨äººé…ç½®
2. ç‚¹å‡»"Hookè„šæœ¬æ–‡ä»¶"æµè§ˆæŒ‰é’®
3. é€‰æ‹©.pyæ–‡ä»¶ä¸Šä¼ 
4. ä¿å­˜åè‡ªåŠ¨ç”Ÿæ•ˆ

**è„šæœ¬è¦æ±‚**ï¼š
```python
def process_message(robot, message_data):
    """
    å¿…é¡»å®ç°æ­¤å‡½æ•°
    
    å‚æ•°:
        robot: æœºå™¨äººå¯¹è±¡å®ä¾‹
        message_data: webhookæ¥æ”¶çš„æ¶ˆæ¯æ•°æ®ï¼ˆdictï¼‰
    
    è¿”å›:
        dict æˆ– None: å¯é€‰çš„å“åº”æ•°æ®
    """
    # å¤„ç†é€»è¾‘
    return response_data  # å¯é€‰
```

---

### 2. æ¶ˆæ¯æ•°é‡é™åˆ¶åŠŸèƒ½ ğŸ“Š

**åŠŸèƒ½è¯´æ˜**ï¼š
- æ¯ä¸ªæœºå™¨äººå¯ç‹¬ç«‹è®¾ç½®æœ€å¤§æ¶ˆæ¯ä¿å­˜æ•°é‡
- é»˜è®¤å€¼ï¼š100æ¡
- å¯é…ç½®èŒƒå›´ï¼š1-1000æ¡
- è¶…å‡ºé™åˆ¶æ—¶è‡ªåŠ¨åˆ é™¤æœ€æ—§çš„æ¶ˆæ¯

**æ•°æ®åº“å˜æ›´**ï¼š
- `Robot`æ¨¡å‹æ–°å¢å­—æ®µï¼š`max_message_count`ï¼ˆIntegerField, default=100ï¼‰
- `Robot`æ¨¡å‹æ–°å¢æ–¹æ³•ï¼š`clean_old_messages()`

**è‡ªåŠ¨æ¸…ç†æ—¶æœº**ï¼š
- æ¥æ”¶webhookæ¶ˆæ¯å
- å‘é€æ¶ˆæ¯å

**é…ç½®æ–¹æ³•**ï¼š
1. ç¼–è¾‘æœºå™¨äºº
2. è®¾ç½®"æœ€å¤§æ¶ˆæ¯è®°å½•æ•°"ï¼ˆ1-1000ï¼‰
3. ä¿å­˜å³å¯

**æ³¨æ„äº‹é¡¹**ï¼š
- æ¸…ç†æ“ä½œä¸å¯é€†
- å»ºè®®æ ¹æ®å®é™…éœ€æ±‚åˆç†è®¾ç½®
- é‡è¦æ¶ˆæ¯è¯·åŠæ—¶å¤‡ä»½

---

### 3. ç«¯å£é…ç½®æ›´æ”¹ ğŸŒ

**å˜æ›´è¯´æ˜**ï¼š
- HTTPç«¯å£ï¼šä»8000æ”¹ä¸º8080
- æ–°å¢HTTPSæ”¯æŒï¼š443ç«¯å£

**å¯åŠ¨æ–¹å¼**ï¼š

#### HTTPæ¨¡å¼ï¼ˆ8080ç«¯å£ï¼‰
```bash
# ä½¿ç”¨æ‰¹å¤„ç†è„šæœ¬
å¯åŠ¨æœåŠ¡å™¨_venv.bat

# æˆ–æ‰‹åŠ¨å¯åŠ¨
python manage.py runserver 8080
```

#### HTTPSæ¨¡å¼ï¼ˆ443ç«¯å£ï¼‰
éœ€è¦é…ç½®SSLè¯ä¹¦ï¼Œæ¨èä½¿ç”¨Nginxåå‘ä»£ç†ï¼š

```bash
# ä½¿ç”¨Nginxé…ç½®æ–‡ä»¶
nginx_config_example.conf

# Nginxé…ç½®è¦ç‚¹ï¼š
- listen 8080 (HTTP)
- listen 443 ssl (HTTPS)
- proxy_pass to Django (8000)
```

**ç”Ÿäº§ç¯å¢ƒæ¨èæ¶æ„**ï¼š
```
å®¢æˆ·ç«¯
  â†“
Nginx (8080/443) â† SSLç»ˆæ­¢
  â†“
Django (8000)
```

---

### 4. å¡ç‰‡æ¶ˆæ¯æ”¯æŒ ğŸ´

**åŠŸèƒ½è¯´æ˜**ï¼š
- æ”¯æŒå‘é€WPSæœºå™¨äººå¡ç‰‡ç±»å‹æ¶ˆæ¯
- æä¾›è¡¨å•å’ŒJSONä¸¤ç§è¾“å…¥æ–¹å¼

**æ¶ˆæ¯æ ¼å¼**ï¼š
```json
{
  "msgtype": "card",
  "card": {
    "title": "å¡ç‰‡æ ‡é¢˜",
    "text": "å¡ç‰‡å†…å®¹",
    "url": "https://example.com"  // å¯é€‰
  }
}
```

**ä½¿ç”¨æ–¹å¼**ï¼š

#### æ–¹å¼ä¸€ï¼šä½¿ç”¨è¡¨å•å­—æ®µ
1. æ¶ˆæ¯ç±»å‹é€‰æ‹©"å¡ç‰‡æ¶ˆæ¯"
2. å¡«å†™"å¡ç‰‡æ ‡é¢˜"
3. å¡«å†™"å¡ç‰‡å†…å®¹"

#### æ–¹å¼äºŒï¼šä½¿ç”¨JSONæ ¼å¼
åœ¨å†…å®¹åŒºåŸŸç›´æ¥è¾“å…¥å®Œæ•´JSONï¼š
```json
{
  "title": "é€šçŸ¥",
  "text": "è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯",
  "url": "https://example.com"
}
```

**è¡¨å•å˜æ›´**ï¼š
- `SendMessageForm`æ–°å¢é€‰é¡¹ï¼š`card`ï¼ˆå¡ç‰‡æ¶ˆæ¯ï¼‰
- æ–°å¢å­—æ®µï¼š`card_title`ã€`card_text`
- å¢å¼ºéªŒè¯é€»è¾‘

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### æ–‡ä»¶ä¸Šä¼ å¤„ç†
```python
# settings.py
MEDIA_URL = '/media/'
MEDIA_ROOT = BASE_DIR / 'media'

# models.py
hook_script_file = models.FileField(
    upload_to='hook_scripts/', 
    blank=True, 
    null=True
)
```

### æ¶ˆæ¯æ¸…ç†å®ç°
```python
def clean_old_messages(self):
    """æ¸…ç†è¶…è¿‡é™åˆ¶çš„æ—§æ¶ˆæ¯"""
    messages = self.messages.order_by('-created_at')
    total_count = messages.count()
    if total_count > self.max_message_count:
        messages_to_delete = messages[self.max_message_count:]
        Message.objects.filter(
            id__in=[m.id for m in messages_to_delete]
        ).delete()
```

### Hookè„šæœ¬æ‰§è¡Œä¼˜å…ˆçº§
1. **ä¸Šä¼ çš„è„šæœ¬æ–‡ä»¶**ï¼ˆhook_script_fileï¼‰- ä¼˜å…ˆçº§æœ€é«˜
2. **é¢„è®¾è„šæœ¬**ï¼ˆhook_scriptï¼‰- ä½œä¸ºå¤‡é€‰

### å¡ç‰‡æ¶ˆæ¯å¤„ç†é€»è¾‘
```python
if msg_type == 'card':
    if content.strip().startswith('{'):
        # JSONæ ¼å¼
        card_data = json.loads(content)
        message_data = {
            'msgtype': 'card',
            'card': card_data
        }
    else:
        # è¡¨å•å­—æ®µ
        message_data = {
            'msgtype': 'card',
            'card': {
                'title': card_title,
                'text': card_text
            }
        }
```

---

## ğŸ“¦ æ•°æ®åº“è¿ç§»

### è‡ªåŠ¨ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶
`robots/migrations/0002_robot_hook_script_file_robot_max_message_count.py`

### è¿ç§»å†…å®¹
```python
operations = [
    migrations.AddField(
        model_name='robot',
        name='hook_script_file',
        field=models.FileField(upload_to='hook_scripts/', ...),
    ),
    migrations.AddField(
        model_name='robot',
        name='max_message_count',
        field=models.IntegerField(default=100, ...),
    ),
]
```

### æ‰§è¡Œè¿ç§»
```bash
python manage.py makemigrations
python manage.py migrate
```

---

## ğŸ“ æ–°å¢æ–‡ä»¶

1. **å¯åŠ¨æœåŠ¡å™¨_HTTPS_443.bat** - HTTPSå¯åŠ¨è„šæœ¬
2. **nginx_config_example.conf** - Nginxé…ç½®ç¤ºä¾‹
3. **README.md** - å®Œæ•´ä½¿ç”¨æ–‡æ¡£ï¼ˆå·²æ›´æ–°ï¼‰
4. **UPDATE_LOG.md** - æœ¬æ›´æ–°è¯´æ˜æ–‡æ¡£

---

## ğŸ”„ ä¿®æ”¹çš„æ–‡ä»¶

### æ ¸å¿ƒæ–‡ä»¶
- `robots/models.py` - æ–°å¢å­—æ®µå’Œæ–¹æ³•
- `robots/views.py` - æ›´æ–°è§†å›¾é€»è¾‘
- `robots/forms.py` - æ–°å¢è¡¨å•å­—æ®µå’ŒéªŒè¯
- `wps_robot/settings.py` - æ·»åŠ MEDIAé…ç½®
- `wps_robot/urls.py` - æ·»åŠ media URLé…ç½®

### å¯åŠ¨è„šæœ¬
- `å¯åŠ¨æœåŠ¡å™¨_venv.bat` - ä¿®æ”¹ä¸º8080ç«¯å£

---

## âš ï¸ é‡è¦æç¤º

### 1. å®‰å…¨æ€§
- **Hookè„šæœ¬ä¸Šä¼ **ï¼šä¸Šä¼ çš„è„šæœ¬ä¼šåœ¨æœåŠ¡å™¨æ‰§è¡Œï¼Œè¯·ç¡®ä¿æ¥æºå¯ä¿¡
- **æ–‡ä»¶æƒé™**ï¼šç¡®ä¿media/ç›®å½•æœ‰å†™å…¥æƒé™
- **SSLè¯ä¹¦**ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨HTTPSï¼ˆ443ç«¯å£ï¼‰

### 2. æ€§èƒ½ä¼˜åŒ–
- æ¶ˆæ¯æ¸…ç†æ˜¯åŒæ­¥æ“ä½œï¼Œå»ºè®®è®¾ç½®åˆç†çš„é™åˆ¶å€¼
- å¤§é‡å†å²æ¶ˆæ¯å»ºè®®æå‰å¤‡ä»½åå†å‡çº§

### 3. å…¼å®¹æ€§
- æ—§ç‰ˆæœ¬æ•°æ®å®Œå…¨å…¼å®¹
- éœ€è¦æ‰§è¡Œæ•°æ®åº“è¿ç§»
- ä¸å½±å“ç°æœ‰åŠŸèƒ½

### 4. ç«¯å£å˜æ›´å½±å“
- **Webhookå›è°ƒURLéœ€è¦æ›´æ–°**
- æ—§çš„8000ç«¯å£ä»å¯ç”¨ï¼ˆæ‰‹åŠ¨æŒ‡å®šï¼‰
- å»ºè®®ä½¿ç”¨Nginxå¤„ç†HTTPS

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. Hookè„šæœ¬ä¸Šä¼ æµ‹è¯•
```python
# test_hook.py
def process_message(robot, message_data):
    return {
        'msgtype': 'text',
        'text': {
            'content': 'æµ‹è¯•æˆåŠŸ'
        }
    }
```

### 2. æ¶ˆæ¯æ¸…ç†æµ‹è¯•
1. è®¾ç½®max_message_count=5
2. å‘é€10æ¡æ¶ˆæ¯
3. éªŒè¯åªä¿ç•™æœ€æ–°5æ¡

### 3. å¡ç‰‡æ¶ˆæ¯æµ‹è¯•
```json
{
  "title": "æµ‹è¯•å¡ç‰‡",
  "text": "è¿™æ˜¯å¡ç‰‡å†…å®¹",
  "url": "https://example.com"
}
```

### 4. ç«¯å£æµ‹è¯•
```bash
# æµ‹è¯•8080ç«¯å£
curl http://127.0.0.1:8080/

# æµ‹è¯•HTTPSï¼ˆå¦‚å·²é…ç½®ï¼‰
curl https://yourdomain:443/
```

---

## ğŸ“ é—®é¢˜åé¦ˆ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æ•°æ®åº“è¿ç§»æ˜¯å¦æˆåŠŸæ‰§è¡Œ
2. mediaç›®å½•æƒé™æ˜¯å¦æ­£ç¡®
3. ç«¯å£æ˜¯å¦è¢«å ç”¨
4. Hookè„šæœ¬è¯­æ³•æ˜¯å¦æ­£ç¡®

---

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

- [ ] æ”¯æŒæ›´å¤šæ¶ˆæ¯ç±»å‹ï¼ˆå›¾ç‰‡ã€æ–‡ä»¶ç­‰ï¼‰
- [ ] æ·»åŠ æ¶ˆæ¯æœç´¢åŠŸèƒ½
- [ ] æ”¯æŒæ¶ˆæ¯å¯¼å‡º
- [ ] Hookè„šæœ¬åœ¨çº¿ç¼–è¾‘å™¨
- [ ] æ›´è¯¦ç»†çš„ç»Ÿè®¡åˆ†æ

---

**ç‰ˆæœ¬**: v2.0  
**æ›´æ–°æ—¶é—´**: 2026-01-30  
**å…¼å®¹ç‰ˆæœ¬**: v1.xï¼ˆéœ€æ‰§è¡Œè¿ç§»ï¼‰
