# Web日志查看器功能说明

## ✅ 功能已添加

已为项目添加完整的Web日志查看和导出功能，可以通过浏览器直接查看、下载和管理日志。

---

## 🌐 访问日志查看器

### 登录后访问
```
http://localhost:80/logs/
```

或者点击左侧导航栏的 **"系统日志"** 菜单。

---

## 📋 主要功能

### 1. 实时查看日志

- **Django日志** - 系统主日志，包含所有INFO及以上级别
- **错误日志** - 仅ERROR级别，快速定位问题
- **Webhook日志** - 机器人webhook详细日志

**特性**:
- 支持选择显示行数：50/100/200/500行
- 自动滚动到底部
- 深色主题，护眼舒适
- 语法高亮（ERROR红色，WARNING黄色，INFO蓝色）

### 2. 自动刷新

- 点击"自动刷新"按钮
- 每3秒自动更新日志内容
- 自动滚动到最新内容
- 实时监控系统运行状态

### 3. 下载日志

**下载单个日志文件**:
- 在日志文件列表中点击"下载"按钮
- 直接下载指定的日志文件

**下载所有日志**:
- 点击页面右上角"下载所有日志"按钮
- 自动打包所有日志为ZIP文件
- 文件名格式：`wps_robot_logs_YYYYMMDD_HHMMSS.zip`

### 4. 清理旧日志

- 点击"清理旧日志"按钮
- 选择清理时间：7/15/30/60/90天前
- 只删除轮转的日志文件（.log.1, .log.2等）
- 不会删除当前正在使用的日志文件

### 5. 日志统计

页面顶部显示：
- 日志文件总数
- 日志总大小
- 当前显示的日志类型和行数

---

## 🎯 使用场景

### 场景1：排查400错误

1. 访问日志查看器：http://localhost:80/logs/
2. 切换到"Webhook日志"标签
3. 启用"自动刷新"
4. 发送测试请求
5. 实时查看详细的请求日志

### 场景2：监控系统运行

1. 访问日志查看器
2. 查看"Django日志"
3. 启用"自动刷新"
4. 监控系统实时运行状态

### 场景3：导出日志给技术支持

1. 点击"下载所有日志"
2. 保存ZIP文件
3. 发送给技术支持人员
4. 包含所有历史日志和轮转文件

### 场景4：定期清理

1. 点击"清理旧日志"
2. 选择"30天前"
3. 确认清理
4. 释放磁盘空间

---

## 📊 日志查看器界面

### 顶部统计卡片
```
┌─────────────────────────┐  ┌─────────────────────────┐
│ 日志文件统计             │  │ 当前显示                │
│ 5 个文件                │  │ 最后 100 行             │
│ 总大小: 2.5 MB          │  │ 日志类型: django        │
└─────────────────────────┘  └─────────────────────────┘
```

### 日志标签页
```
┌───────────────────────────────────────────────────┐
│ [Django日志] [错误日志] [Webhook日志]               │
├───────────────────────────────────────────────────┤
│ [50行] [100行] [200行] [500行]    [刷新] [自动刷新] │
├───────────────────────────────────────────────────┤
│                                                   │
│  日志内容显示区域（深色主题）                        │
│  [INFO] 2026-01-30 18:30:45 ...                   │
│  [ERROR] 2026-01-30 18:30:46 ...                  │
│                                                   │
└───────────────────────────────────────────────────┘
```

### 文件列表
```
┌───────────────────────────────────────────────────┐
│ 📁 日志文件列表                                    │
├────────────┬──────────┬────────────────┬─────────┤
│ 文件名      │ 大小     │ 修改时间        │ 操作    │
├────────────┼──────────┼────────────────┼─────────┤
│ django.log │ 1.2 MB   │ 2026-01-30 ... │ [下载]  │
│ error.log  │ 0.3 MB   │ 2026-01-30 ... │ [下载]  │
│ webhook.log│ 0.8 MB   │ 2026-01-30 ... │ [下载]  │
└────────────┴──────────┴────────────────┴─────────┘
```

---

## 🔧 技术实现

### 新增文件

1. **views.py** - 添加了5个视图函数：
   - `logs_viewer()` - 日志查看器主页面
   - `download_log()` - 下载单个日志文件
   - `download_all_logs()` - 下载所有日志（ZIP）
   - `clear_logs()` - 清理旧日志
   - `api_log_tail()` - API：获取日志尾部内容

2. **urls.py** - 添加了5个URL路由：
   - `/logs/` - 日志查看器
   - `/logs/download/<log_name>` - 下载单个日志
   - `/logs/download-all/` - 下载所有日志
   - `/logs/clear/` - 清理日志
   - `/api/logs/tail/` - 日志尾部API

3. **logs_viewer.html** - 日志查看器HTML模板
   - 响应式设计
   - Bootstrap 5风格
   - 实时刷新功能
   - AJAX轮询

4. **base.html** - 更新了导航菜单
   - 添加"系统日志"菜单项

---

## 🔒 安全特性

### 1. 登录验证
- 所有日志功能都需要登录
- 使用 `@login_required` 装饰器

### 2. 路径安全
- 防止路径遍历攻击
- 只能访问logs目录中的文件
- 使用 `Path.resolve()` 验证路径

### 3. 权限控制
- 所有已登录用户都可以查看日志
- 未来可以限制为仅管理员查看

---

## 📱 响应式设计

- 支持桌面浏览器
- 支持平板设备
- 支持手机浏览器
- 自适应布局

---

## 🎨 用户体验

### 深色主题日志查看器
- 背景：深色
- 文字：浅色
- 减少眼睛疲劳
- 专业的代码编辑器风格

### 实时刷新
- 不需要手动刷新页面
- 自动滚动到最新内容
- 可随时启动/停止

### 快捷操作
- 一键下载所有日志
- 快速切换日志类型
- 灵活选择显示行数

---

## 📝 使用建议

### 日常运维
1. 每天查看一次错误日志
2. 启用自动刷新监控实时状态
3. 每月清理一次30天前的旧日志

### 问题排查
1. 出现问题时先查看错误日志
2. 查看Webhook日志了解请求详情
3. 下载日志保存为诊断依据

### 性能优化
1. 日志文件超过10MB会自动轮转
2. 定期清理旧日志释放空间
3. 只保留必要的日志文件

---

## 🚀 下一步

### 测试功能
```bash
# 1. 重启服务
python manage.py runserver 0.0.0.0:80

# 2. 访问日志查看器
# 浏览器打开: http://localhost:80/logs/

# 3. 测试各项功能
# - 查看不同类型的日志
# - 启用自动刷新
# - 下载日志文件
# - 清理旧日志
```

### 排查400错误
```bash
# 1. 访问Webhook日志
http://localhost:80/logs/?type=webhook

# 2. 启用自动刷新

# 3. 发送测试请求
curl -X POST http://localhost:80/at_robot/admin/test \
  -H "Content-Type: application/json" \
  -d '{"msgtype":"text","text":{"content":"test"}}'

# 4. 查看实时日志输出
```

---

## 💡 提示

### 快速访问
将日志查看器添加到浏览器书签：
```
http://localhost:80/logs/
```

### 键盘快捷键
- `F5` - 刷新页面
- `Ctrl+F` - 在日志中搜索
- `Home` - 滚动到顶部
- `End` - 滚动到底部

### 移动端访问
使用手机浏览器访问：
```
http://你的服务器IP:80/logs/
```

---

## 📞 相关文档

- [LOGS_GUIDE.md](LOGS_GUIDE.md) - 详细日志使用指南
- [LOGS_SETUP_SUMMARY.md](LOGS_SETUP_SUMMARY.md) - 日志系统配置总结
- [README.md](../README.md) - 项目主文档

---

**功能添加完成时间**: 2026-01-30

**版本**: v2.1

现在你可以通过Web界面轻松查看和导出项目日志了！🎉
